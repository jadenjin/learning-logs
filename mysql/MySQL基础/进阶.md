# MySQL进阶篇

## MySQL体系结构

![image-20240713080513125](.\进阶.assets\image-20240713080513125.png)

* 连接层：最上层是一些客户端和链接服务，主要完成一些类似于连接处理、授权认证、及相关的安全方案。服务器也会为安全接入的每个客户。

* 服务层：第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化，部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。

* 引擎层：存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API和存储引擎进行通信。不同的存储引擎具有不同的功能，这样我们可以根据自己的需要，来选取合适的存储引擎

* 存储层：主要是将数据存储在文件系统之上，并完成与存储引擎的交互。

## 存储引擎

存储引擎就是存储数据、建立索引、更新/查询数据等技术的实现方式。存储引擎是基于的，而不是基于库的，所以存储引擎也可被称为表类型。

```
查询建表语句
show create table account;
查询当前数据库支持的引擎
show engines;
指定引擎
create table my_menory(
int id,
name varchar(10)
) engine = MyISAM;
```

## InnoDB

特点:

* DML操作遵循ACID模型，支持**事务**；
* **行级锁**，提高并发访问性能；
* 支持外键FOREIGN KEY访问，保证数据的完整性和正确性；

文件:xxx.ibd

![image-20240713083049618](.\进阶.assets\image-20240713083049618.png)

## MyISAM

特点：

* 不支持事务，不支持外键
* 支持表锁，不支持行锁
* 访问速度快

## Memory

特点：

* 内存存放
* hash索引(默认)

| 特点         |   InnoDB   | MyISAM | Memory |
| ------------ | :--------: | :----: | :----: |
| 存储限制     |    64TB    |   有   |   有   |
| 事务安全     |  **支持**  |   -    |   -    |
| 锁机制       |  **行锁**  |  表锁  |  表锁  |
| B+tree索引   |    支持    |  支持  |  支持  |
| Hash索引     |     -      |   -    |  支持  |
| 全文索引     | 支持(5.6+) |  支持  |   -    |
| 空间使用     |     高     |   低   |  N/A   |
| 内存使用     |     高     |   低   |  中等  |
| 批量插入速度 |     低     |   高   |   高   |
| 支持外键     |  **支持**  |   -    |   -    |

![image-20240713084817889](.\进阶.assets\image-20240713084817889.png)

存储引擎选择：

* InnoDB：MySQL默认引擎，支持事务、外键。如果应用对事务的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询之外，还包含很多的更新、删除操作，那么InnoDB存储引擎是比较合适的选择。
* MyISAM：如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不是很高，那么选择这个存储引擎是非常合适的。
* MEMORY：将所有数据保存在内存中，访问速度快，通常用于临时表及缓存。MEMORY的缺陷就是对表的大小有限制，太大的表无法缓存在内存中，而且无法保障数据的安全性。

## 索引

索引（index）是帮助MySQL高效获取数据的数据结构（有序）。在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。

| 索引结构         | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| B+Tree索引       | 最常见的索引，大部分引擎都支持B+树索引                       |
| Hash索引         | 底层数据结构是用哈希表实现的，只有精确匹配索引列的查询才有效，不支持范围查询 |
| R-tree(空间索引) | MyISAM引擎的一个特殊索引类型，主要用于地理空间数据类型       |
| Full-text        | 通过建立倒排索引，快速匹配文档的方式，类似于Lucene,Solr,ES   |

分类

| 分类     | 含义                                       | 特点                     | 关键字   |
| -------- | ------------------------------------------ | ------------------------ | -------- |
| 主键索引 | 针对于表中主键创建的索引                   | 默认自动创建，只能有一个 | PRIMARY  |
| 唯一索引 | 避免同一个表中某数据列中的值重复           | 可以有多个               | UNIQUE   |
| 常规索引 | 快速定位特定数据                           | 可以有多个               |          |
| 全文索引 | 查找的是文本中的关键词，而不是比较索引的值 | 可以有多个               | FULLTEXT |

| 分类     | 含义                                                       | 特点                 |
| -------- | ---------------------------------------------------------- | -------------------- |
| 聚集索引 | 将数据存储与索引放到了一块，索引结构的叶子节点保存了行数据 | 必须有，而且只有一个 |
| 二级索引 | 将数据与索引分开存储，索引结构的叶子节点关联的是对应的主键 | 可以存在多个         |

索引语法

创建

```
CREATE [UNIQUE|FULLTEXT] INDEX index_name ON table_name (index_col_name,...);
```

查看索引

```
SHOW INDEX FROM table_name;
```

删除索引

```
DROP INDEX index_name ON table_name;
```

示例:

```
P75
```

## SQL性能分析

```
SHOW [session|global] status like 'Com_______';
```

慢查询日志:
```
show variables like 'slow_query_log';
```

开启配置:

修改/etc/my.cnf

```
slow_query_log=1#开启慢查询日志开关
long_query_time=2#设置慢日志时间为2s
```

日志位置:/var/lib/mysql/localhost-slow.log

profile详情

```
SELECT @@have_profiling;#查看是否支持
SET profiling = 1;#开启
show profiles;#查看每一条SQL的耗时基本情况
show profile for query query_id;#查看指定query_id的SQL语句各个阶段耗时情况
show profile cpu for query query_id;#查看指定query_id的SQL语句CPU的使用情况
```

explain执行计划

```
直接在select语句之前加上关键字explain/desc
EXPLAIN SELECT 字段列表 FROM 表名 WHERE 条件
```

各字段含义

* ID: SELECT 查询的序列号，表示查询中执行select子句或者是操作表的顺序(id相同，执行顺序从上往下；id不同，值越大，越先执行)。

* select_type: 表示SELECT的类型，常见的取值有SIMPLE(简单表，不使用表连接或者子查询)、PRIMARY(主查询，即外层的查询)、UNION(UNION中的第二个或者后面的查询语句)、SUBQUERY(SELECT/WHERE之后包含了子查询)等

* **type**:表示连接类型,性能由好到差的连接类型为NULL,system(系统表)，const(主键或者唯一索引)，eq_ref，ref(非唯一性索引)，range，index(用了索引还是进行了全表扫描)，all。
* **possible_key**: 显示可能应用在这张表上的索引，一个或者多个
* **key**: 实际用到的索引
* **key_len**: 索引使用的字节数，该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下，长度越短越好。
* rows:MYSQL认为必须要执行查询的行数,在innodb引擎的表中,是一个估计值,可能并不总是准确的。
* filtered: 表示返回结果的行数占需读取行数的百分比,filtered的值越大越好。

## 索引的使用

1. 最左前缀法则

如果索引了多列(联合索引),要遵循最左前缀法则。最左前缀法则指的是查询从索引的最左列开始，并且不跳过索引中的列。如果跳过某一列，索引将部分失效(后面的字段索引失效)。和位置无关

2. 范围查询

联合索引中，出现范围查询(>,<)，范围查询右侧的列索引失效。

规避：>=或者<=

## 索引失效

* 索引列运算

不要在索引列上进行运算操作,索引将失效。

* 字符串不加引号

字符串类型字段使用时，不加引号，索引将失效。

* 模糊查询

如果仅仅是尾部模糊匹配，索引不会失效。如果是头部模糊匹配，索引失效。

* or的连接条件

用or分割开的条件，如果or前的条件中的列有索引，而后面的列没有索引，那么涉及到的索引都不会被用到。

* 数据分布影响

如果MySQL评估使用索引比全表更慢，则不使用索引。

## SQL提示

```
use index
EXPLAIN select * from xxx use index(idx_xxx) where...
ignore index
EXPLAIN select * from xxx ignore index(idx_xxx) where...
force index
EXPLAIN select * from xxx force index(idx_xxx) where...
```

覆盖索引

尽量使用覆盖索引(查询使用了索引，并且需要返回的列，在该索引中已经全部能够找到)，减少select *

```
using index condition:查找使用了索引，但是需要回表查询数据。
using where;using index：查找使用了索引，但是需要的数据都在索引列中能够找到，所以不需要回表查询数据。
```

